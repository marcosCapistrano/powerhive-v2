<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Balancer</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav>
        <div class="nav-brand">Power Balancer</div>
        <div class="nav-links">
            <a href="/" class="active">Painel</a>
            <a href="/models">Modelos</a>
            <a href="/logs">Registros</a>
        </div>
    </nav>

    <main>
        <div class="status-bar" id="status-bar">
            <div class="status-item">
                <span class="status-label">Estado</span>
                <span class="status-value state-badge" id="state">{{.Status.State}}</span>
            </div>
            <div class="status-item">
                <span class="status-label">Geração</span>
                <span class="status-value" id="generation">{{printf "%.2f" .Status.GenerationMW}} MW</span>
            </div>
            <div class="status-item">
                <span class="status-label">Consumo</span>
                <span class="status-value" id="consumption">{{printf "%.2f" .Status.ConsumptionMW}} MW</span>
            </div>
            <div class="status-item">
                <span class="status-label">Margem</span>
                <span class="status-value" id="margin">{{printf "%.1f" .Status.MarginPercent}}%</span>
            </div>
            <div class="status-item">
                <span class="status-label">Margem Efetiva</span>
                <span class="status-value" id="effective-margin">{{printf "%.1f" .Status.EffectiveMarginPercent}}%</span>
            </div>
            <div class="status-item">
                <span class="status-label">Delta Pendente</span>
                <span class="status-value" id="pending-delta">{{.Status.PendingDeltaW}} W</span>
            </div>
        </div>

        <div class="turbines">
            <h2>Turbinas</h2>
            <div class="turbine-grid">
                <div class="turbine-card" id="generoso">
                    <h3>Generoso</h3>
                    <div class="turbine-status-line">
                        <span class="status-dot {{if eq .Status.GenerosoStatus "success"}}online{{else}}offline{{end}}" id="generoso-dot"></span>
                        <span id="generoso-status">{{if eq .Status.GenerosoStatus "success"}}Online{{else}}Offline{{end}}</span>
                    </div>
                    <div class="turbine-power" id="generoso-power">{{printf "%.2f" .Status.GenerosoMW}} MW</div>
                </div>
                <div class="turbine-card" id="nogueira">
                    <h3>Nogueira</h3>
                    <div class="turbine-status-line">
                        <span class="status-dot {{if eq .Status.NogueiraStatus "success"}}online{{else}}offline{{end}}" id="nogueira-dot"></span>
                        <span id="nogueira-status">{{if eq .Status.NogueiraStatus "success"}}Online{{else}}Offline{{end}}</span>
                    </div>
                    <div class="turbine-power" id="nogueira-power">{{printf "%.2f" .Status.NogueiraMW}} MW</div>
                </div>
            </div>
        </div>

        <div class="miners-section">
            <h2>Mineradores Gerenciados</h2>
            <p>Total: <span id="miner-count">{{.Status.ManagedMinersCount}}</span> |
               Em Espera: <span id="cooldown-count">{{.Status.MinersOnCooldown}}</span></p>
            <div id="miners-table">
                <p>Carregando mineradores...</p>
            </div>
        </div>
    </main>

    <script>
        // SSE for live updates
        const evtSource = new EventSource('/api/sse');

        evtSource.addEventListener('status', function(e) {
            const status = JSON.parse(e.data);
            document.getElementById('state').textContent = status.state;
            document.getElementById('state').className = 'status-value state-badge state-' + status.state.toLowerCase();
            document.getElementById('generation').textContent = status.generation_mw.toFixed(2) + ' MW';
            document.getElementById('consumption').textContent = status.consumption_mw.toFixed(2) + ' MW';
            document.getElementById('margin').textContent = status.margin_percent.toFixed(1) + '%';
            document.getElementById('effective-margin').textContent = status.effective_margin_percent.toFixed(1) + '%';
            document.getElementById('pending-delta').textContent = status.pending_delta_w + ' W';
            document.getElementById('miner-count').textContent = status.managed_miners_count;
            document.getElementById('cooldown-count').textContent = status.miners_on_cooldown;

            // Update turbines
            const generosoOnline = status.generoso_status === 'success';
            document.getElementById('generoso-dot').className = 'status-dot ' + (generosoOnline ? 'online' : 'offline');
            document.getElementById('generoso-status').textContent = generosoOnline ? 'Online' : 'Offline';
            document.getElementById('generoso-power').textContent = status.generoso_mw.toFixed(2) + ' MW';

            const nogueiraOnline = status.nogueira_status === 'success';
            document.getElementById('nogueira-dot').className = 'status-dot ' + (nogueiraOnline ? 'online' : 'offline');
            document.getElementById('nogueira-status').textContent = nogueiraOnline ? 'Online' : 'Offline';
            document.getElementById('nogueira-power').textContent = status.nogueira_mw.toFixed(2) + ' MW';
        });

        // Load miners
        async function loadMiners() {
            try {
                const response = await fetch('/api/miners');
                const miners = await response.json();
                renderMiners(miners);
            } catch (err) {
                console.error('Falha ao carregar mineradores:', err);
            }
        }

        function renderMiners(miners) {
            const container = document.getElementById('miners-table');
            if (!miners || miners.length === 0) {
                container.innerHTML = '<p>Nenhum minerador descoberto ainda.</p>';
                return;
            }

            let html = '<table><thead><tr>';
            html += '<th>Status</th><th>IP</th><th>Modelo</th><th>Preset</th><th>Habilitado</th><th>Espera</th><th>Ações</th>';
            html += '</tr></thead><tbody>';

            for (const miner of miners) {
                const preset = miner.current_preset ? miner.current_preset.name : 'Desconhecido';
                const model = miner.model ? miner.model.name : 'Desconhecido';
                const enabled = miner.config && miner.config.enabled ? 'Sim' : 'Não';
                const cooldown = miner.cooldown ? formatCooldown(miner.cooldown.until) : '-';
                const online = miner.is_online;
                const statusClass = online ? 'online' : 'offline';
                const statusText = online ? 'Online' : 'Offline';

                html += `<tr class="${statusClass}">`;
                html += `<td><span class="status-dot ${statusClass}"></span> ${statusText}</td>`;
                html += `<td>${miner.ip_address}</td>`;
                html += `<td>${model}</td>`;
                html += `<td>${preset}</td>`;
                html += `<td>${enabled}</td>`;
                html += `<td>${cooldown}</td>`;
                html += `<td><button onclick="toggleMiner(${miner.id}, ${!(miner.config && miner.config.enabled)})" ${!online ? 'disabled' : ''}>${enabled === 'Sim' ? 'Desabilitar' : 'Habilitar'}</button></td>`;
                html += '</tr>';
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function formatCooldown(until) {
            const now = new Date();
            const end = new Date(until);
            const diff = end - now;
            if (diff <= 0) return '-';
            const mins = Math.floor(diff / 60000);
            const secs = Math.floor((diff % 60000) / 1000);
            return `${mins}m ${secs}s`;
        }

        async function toggleMiner(minerID, enabled) {
            try {
                await fetch('/api/miners/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({miner_id: minerID, enabled: enabled})
                });
                loadMiners();
            } catch (err) {
                console.error('Falha ao alternar minerador:', err);
            }
        }

        // Initial load
        loadMiners();
        setInterval(loadMiners, 10000);
    </script>
</body>
</html>
