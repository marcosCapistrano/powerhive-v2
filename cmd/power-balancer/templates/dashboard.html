<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Balancer</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav>
        <div class="nav-brand">Power Balancer</div>
        <div class="nav-links">
            <a href="/" class="active">Dashboard</a>
            <a href="/models">Models</a>
            <a href="/logs">Logs</a>
        </div>
    </nav>

    <main>
        <div class="status-bar" id="status-bar">
            <div class="status-item">
                <span class="status-label">State</span>
                <span class="status-value state-badge" id="state">{{.Status.State}}</span>
            </div>
            <div class="status-item">
                <span class="status-label">Generation</span>
                <span class="status-value" id="generation">{{printf "%.2f" .Status.GenerationMW}} MW</span>
            </div>
            <div class="status-item">
                <span class="status-label">Consumption</span>
                <span class="status-value" id="consumption">{{printf "%.2f" .Status.ConsumptionMW}} MW</span>
            </div>
            <div class="status-item">
                <span class="status-label">Margin</span>
                <span class="status-value" id="margin">{{printf "%.1f" .Status.MarginPercent}}%</span>
            </div>
            <div class="status-item">
                <span class="status-label">Effective Margin</span>
                <span class="status-value" id="effective-margin">{{printf "%.1f" .Status.EffectiveMarginPercent}}%</span>
            </div>
            <div class="status-item">
                <span class="status-label">Pending Delta</span>
                <span class="status-value" id="pending-delta">{{.Status.PendingDeltaW}} W</span>
            </div>
        </div>

        <div class="turbines">
            <h2>Turbines</h2>
            <div class="turbine-grid">
                <div class="turbine-card" id="generoso">
                    <h3>Generoso</h3>
                    <div class="turbine-status">{{.Status.GenerosoStatus}}</div>
                </div>
                <div class="turbine-card" id="nogueira">
                    <h3>Nogueira</h3>
                    <div class="turbine-status">{{.Status.NogueiraStatus}}</div>
                </div>
            </div>
        </div>

        <div class="miners-section">
            <h2>Managed Miners</h2>
            <p>Total: <span id="miner-count">{{.Status.ManagedMinersCount}}</span> |
               On Cooldown: <span id="cooldown-count">{{.Status.MinersOnCooldown}}</span></p>
            <div id="miners-table">
                <p>Loading miners...</p>
            </div>
        </div>
    </main>

    <script>
        // SSE for live updates
        const evtSource = new EventSource('/api/sse');

        evtSource.addEventListener('status', function(e) {
            const status = JSON.parse(e.data);
            document.getElementById('state').textContent = status.state;
            document.getElementById('state').className = 'status-value state-badge state-' + status.state.toLowerCase();
            document.getElementById('generation').textContent = status.generation_mw.toFixed(2) + ' MW';
            document.getElementById('consumption').textContent = status.consumption_mw.toFixed(2) + ' MW';
            document.getElementById('margin').textContent = status.margin_percent.toFixed(1) + '%';
            document.getElementById('effective-margin').textContent = status.effective_margin_percent.toFixed(1) + '%';
            document.getElementById('pending-delta').textContent = status.pending_delta_w + ' W';
            document.getElementById('miner-count').textContent = status.managed_miners_count;
            document.getElementById('cooldown-count').textContent = status.miners_on_cooldown;
        });

        // Load miners
        async function loadMiners() {
            try {
                const response = await fetch('/api/miners');
                const miners = await response.json();
                renderMiners(miners);
            } catch (err) {
                console.error('Failed to load miners:', err);
            }
        }

        function renderMiners(miners) {
            const container = document.getElementById('miners-table');
            if (!miners || miners.length === 0) {
                container.innerHTML = '<p>No miners discovered yet.</p>';
                return;
            }

            let html = '<table><thead><tr>';
            html += '<th>Status</th><th>IP</th><th>Model</th><th>Preset</th><th>Enabled</th><th>Cooldown</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            for (const miner of miners) {
                const preset = miner.current_preset ? miner.current_preset.name : 'Unknown';
                const model = miner.model ? miner.model.name : 'Unknown';
                const enabled = miner.config && miner.config.enabled ? 'Yes' : 'No';
                const cooldown = miner.cooldown ? formatCooldown(miner.cooldown.until) : '-';
                const online = miner.is_online;
                const statusClass = online ? 'online' : 'offline';
                const statusText = online ? 'Online' : 'Offline';

                html += `<tr class="${statusClass}">`;
                html += `<td><span class="status-dot ${statusClass}"></span> ${statusText}</td>`;
                html += `<td>${miner.ip_address}</td>`;
                html += `<td>${model}</td>`;
                html += `<td>${preset}</td>`;
                html += `<td>${enabled}</td>`;
                html += `<td>${cooldown}</td>`;
                html += `<td><button onclick="toggleMiner(${miner.id}, ${!(miner.config && miner.config.enabled)})" ${!online ? 'disabled' : ''}>${enabled === 'Yes' ? 'Disable' : 'Enable'}</button></td>`;
                html += '</tr>';
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function formatCooldown(until) {
            const now = new Date();
            const end = new Date(until);
            const diff = end - now;
            if (diff <= 0) return '-';
            const mins = Math.floor(diff / 60000);
            const secs = Math.floor((diff % 60000) / 1000);
            return `${mins}m ${secs}s`;
        }

        async function toggleMiner(minerID, enabled) {
            try {
                await fetch('/api/miners/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({miner_id: minerID, enabled: enabled})
                });
                loadMiners();
            } catch (err) {
                console.error('Failed to toggle miner:', err);
            }
        }

        // Initial load
        loadMiners();
        setInterval(loadMiners, 10000);
    </script>
</body>
</html>
